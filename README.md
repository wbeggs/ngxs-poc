# NgxsPatterns

This project was made to POC patterns that we may want to use for our future projects

## Folder structure
- State folder lives within app holds all of state
- app-state-module.ts, app-state-service.ts and app-state.ts, app-actions.ts, and app-order-customer-models.ts live in State folder.
    - app-state.ts is the root state that our individual state slices are children of.
    - app-state-service exposes the root state for consumption by othe services and components.
- Individual state slices live within their own folders i.e. customer, eligibility, payments etc., and contain the same files as the root app state (with the exception of the module), but with their slice name in place of 'app'.
- Individual state slices services are provided and exposed by the app-state-module.ts.

## Description of files within state   
- state services are what expose the state to services and components, and are injected into them. 
- state models expose the interfaces, enums and types that model the accompanying state.
- state itself contains the action and selector implementations.
- state actions file contains action definitions used by the state. 

## State integrity
- Data going into state can come from two sources, either an external api or generated within the app (persistent storage vs ui state).
- Data that is fed from an external api should be refreshed from the api, not updated by UI logic.
- Data within a state slice should be organized in a way that the following items are not combined on an object within a state slice:
  - static data from an external api (data that will not change in a session)
  - data that can change in a session, but should be fed from an external api
  - static data generated in a session by the app
  - dynamic data generated by the app
- Data objects within a slice should be organized to reduce (or hopefully remove) the risk of needing to perform deep merges of state
  - i.e. anything more than deeper than a key that sits on the slice itself.
- components and non-state services should not be able to dispatch state actions directly, only through state services.
- Components and non-state services should retrieve all state data through selectors

## Flow 
- Components and services retrieve data from the state through selectors. 
- Data is pushed into state through functions exposed on the state service.
- The state service then has the opportunity to gatekeep, modify, access apis etc before updating state.
- If the request is to load state from an external api, the component or service with notify the state service, and then the state service will make the api call map the result and dispatch the action to push it into state.
- If the request is updating persistent data stores, the state service makes the call to the external api to update it, and then pushes the result or into state or possibly makes a new query to refresh any part of state that may be updated as a result of the api call. The service does not make assumptions of what persistent state will be after making the call.

## Derived/computed properties
- State never contains properties that can be derived from other pieces of state. This can create inconsistencies and results in UI bugs and multiple sources of truth.
- Properties that can be derived from other data in state is exposed through custom selectors.
- Custom selectors should be optimized so they don't recieve all of state each time they calculate. (https://www.ngxs.io/advanced/optimizing-selectors)
- Some properties such as incrementors that don't go to persistent data stores can't be derived, but are calculated. these can be calculated directly in the action. 
- Selectors only memoize previous inputs so we don't recalculate the same thing twice in a row
- Setting up state with ```injectContainerState: false``` allows us to create selectors that listen to another selector instead of all of state so we fire only when that part of state fires, not when any part of that slice fires.

## General responsibility of individual files

### State slices
- Clearly defined chunks of related state.
- Contain an object with any number of keys that represent chunks of state that might be updated individually.
- Should not mix data relating to external data stores with data generated by the app.
- Contains actions that push data into the store.
- Contains actions that break down into other actions.
- Contains actions that cannot be derived from other store data but are calculated such as an incrementor.
- Contains selectors that expose data derived from other members of state. 
- Never push data into a store that can be derived from the store itself.
- Avoid actions that set a static state.
  - Example, an action that Marries someone and one that Divorces should not be used. Instead have an action that updates marital status and let the value be passed in.
- Should not house a hierarchy of related data. That allows all actions to do a patchState instead of a custom deep merge.   
  - For example, We may want to have a payments slice that contains future and past payments. We may want to further break down future payments into ones that have already been satisfied and scheduled payments. This creates a scenario where we may want to update satisfied payments, but we have to dispatch the entire future payments section each time make an update. A better structure might be to have a payment schedule slice, a payment history slice, etc.

### State services
State services expose the state to the rest of the app and are the only way in which the app interacts with state with the exception of @Select decorators.
- Handles calls to external apis for all external crud operations (through an injected api service)
- Houses logic to mutate data from the app before it is pushed into state
- Works with utils or other logic needed to process data before pushing it into state
- Handles mapping of data from the app or external apis to match state structure
- Works with other storage such as cookies and local storage
- Dispatches actions on the state slice
- State services are not injected into other state services with the exception of slices being injected into app state

### Actions
- Contains action definitions that are used by state services to dispatch actions to the underlying state slice.

### Models
Models has all types required to define the slice of state they are embedded with
- Models should begin with the name of the slice of state they come from 
 - i.e. ```export interface ICustomerBasicInfo```
- Contains interfaces, types, classes and enums that define data held in that slice of state

### App state service
The app state service is the root of our ngxs store. It houses basic app information, and is the parent to all other state slices. This puts it in a special position where it can handle things that encompass more than one slice of state.
- May handle calls to an external api that will feed into multiple slices of state. This cuts down on the number of calls we have to make and gives us better control.
  - For example, on initial site load, we may want some basic customer and order information for our dashboard before we make bulkier calls for the details on those things.
- May hold basic app information
- May inject other state services to handle logic that affects multiple slices

### Getting data into state


## Development server

Run `ng serve` for a dev server. Navigate to `http://localhost:4200/`. The app will automatically reload if you change any of the source files.

## Code scaffolding

Run `ng generate component component-name` to generate a new component. You can also use `ng generate directive|pipe|service|class|guard|interface|enum|module`.

## Build

Run `ng build` to build the project. The build artifacts will be stored in the `dist/` directory. Use the `--prod` flag for a production build.

## Running unit tests

Run `ng test` to execute the unit tests via [Karma](https://karma-runner.github.io).

## Running end-to-end tests

Run `ng e2e` to execute the end-to-end tests via [Protractor](http://www.protractortest.org/).

## Further help

To get more help on the Angular CLI use `ng help` or go check out the [Angular CLI Overview and Command Reference](https://angular.io/cli) page.
